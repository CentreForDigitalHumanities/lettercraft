<ng-container *ngIf="data$ | async as data">
    <ng-container *ngIf="data.episode">
        <p>The following agents are involved in this episode:</p>
        <ul class="list-unstyled vstack gap-4">
            <li *ngFor="let agent of data.episode.agents">
                <lc-episode-link-form [entityType]="entityType" linkTo="entity"
                        [entityID]="agent.id"
                        [episodeID]="data.episode.id">
                    <button removeControl class="btn btn-danger" aria-label="remove episode"
                        (click)="removeAgent$.next(agent.id)">
                        <lc-icon [icon]="actionIcons.remove" />
                    </button>
                </lc-episode-link-form>
            </li>
        </ul>
    </ng-container>
</ng-container>

<div class="mt-4 mb-4">
    <div ngbDropdown>
        <button type="button" class="btn btn-primary" id="add-agent-dropdown-trigger"
            ngbDropdownToggle>
            Add agent
        </button>
        <div ngbDropdownMenu aria-labelledby="add-agent-dropdown-trigger">
            <button *ngFor="let agent of (availableAgents$ | async)"
                ngbDropdownItem (click)="addAgent$.next(agent.id)">
                {{agent.name}}
            </button>
            <button ngbDropdownItem (click)="openNewAgentModal(newAgentModal)">
                <lc-icon [icon]="actionIcons.create" />
                Create new agent
            </button>
        </div>
    </div>
</div>

<ng-template #newAgentModal>
    <lc-base-modal (dismiss)="closeModal()" *ngIf="(data$ | async)?.episode as episode">
        <ng-container modal-header>
            <h4 ngbAutofocus>Create new agent</h4>
        </ng-container>
        <ng-container modal-content>
            <lc-new-agent-form #newAgentForm
                [sourceID]="episode.source.id"
                [episodeID]="episode.id"
                (mutationStarted)="createMutationInProgress = true"
                (agentCreated)="closeModal()" />
        </ng-container>
        <ng-container modal-footer>
            <button
                type="button"
                class="btn btn-primary"
                (click)="newAgentForm.submit()"
            >
                Create
                <div class="spinner-border spinner-border-sm"
                    *ngIf="createMutationInProgress">
                    <span class="visually-hidden">Creating new agent...</span>
                </div>
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                (click)="closeModal()"
            >
                Cancel
            </button>
        </ng-container>
    </lc-base-modal>
</ng-template>
